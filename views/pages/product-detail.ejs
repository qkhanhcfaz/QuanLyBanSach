<!-- File: /views/pages/product-detail.ejs (Phiên bản đã fix - không bị lặp) -->
<%- include('../partials/header') %>

<div class="container my-5">
  <div class="row">

    <!-- CỘT TRÁI: HÌNH ẢNH SẢN PHẨM -->
    <div class="col-lg-4 mb-4 mb-lg-0">
      <div class="product-image-container">
        <img
          class="img-fluid rounded"
          src="<%= (product.img && (product.img.startsWith('http') || product.img.startsWith('/'))) ? product.img : '/images/' + (product.img || 'placeholder.png') %>"
          alt="<%= product.ten_sach %>"
        >
      </div>
    </div>

    <!-- CỘT GIỮA: THÔNG TIN CHI TIẾT SẢN PHẨM -->
    <div class="col-lg-5">
      <h1 class="product-title display-6"><%= product.ten_sach %></h1>

      <!-- Thông tin Tác giả và NXB -->
      <div class="product-meta mb-3">
        <span>Tác giả: <%= product.tac_gia || 'Đang cập nhật' %></span>
        <span class="mx-2">|</span>
        <span>NXB: <%= product.nha_xuat_ban || 'Đang cập nhật' %></span>
      </div>

      <!-- Giá sản phẩm -->
      <div class="product-price-wrapper mb-3">
        <h2 class="text-danger fw-bold mb-2">
          <%= parseFloat(product.gia_bia).toLocaleString('vi-VN') %> đ
        </h2>

        <!-- Stock Status Badge -->
        <div class="mb-3">
          <% if (product.so_luong_ton_kho > 0) { %>
            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Còn hàng</span>
          <% } else { %>
            <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Hết hàng</span>
          <% } %>
        </div>

        <!-- Realtime Stats -->
        <div class="d-flex align-items-center mb-3">
          <div class="me-3" title="Lượt xem">
            <i class="fas fa-eye text-muted me-1"></i>
            <span><%= product.views %></span>
          </div>
          <div class="me-3" title="Lượt thích">
            <i class="fas fa-heart text-danger me-1"></i>
            <span><%= favoriteCount %></span>
          </div>
          <div class="me-3" title="Đánh giá trung bình">
            <i class="fas fa-star text-warning me-1"></i>
            <span><%= avgRating %> / 5</span>
          </div>
        </div>

        <div class="text-muted">
          <%- product.mo_ta_ngan ? product.mo_ta_ngan : 'Đang cập nhật mô tả...' %>
        </div>
      </div>

      <hr>

      <!-- Bộ chọn số lượng và nút Thêm vào giỏ -->
      <div class="d-flex align-items-center mb-4">
        <span class="me-3">Số lượng:</span>
        <div class="input-group quantity-selector me-3" style="width: 120px;">
          <button class="btn btn-outline-secondary" type="button" id="button-minus">-</button>
          <input
            type="text"
            id="quantity-input"
            class="form-control text-center"
            value="1"
            min="1"
            max="<%= product.so_luong_ton_kho %>"
          >
          <button class="btn btn-outline-secondary" type="button" id="button-plus">+</button>
        </div>
      </div>

      <% 
        const isFav =
          (typeof favoriteProductIds !== 'undefined') &&
          favoriteProductIds.some(id => String(id) === String(product.id));
      %>

      <div class="d-flex gap-2">
        <button
          onclick="addToCart('<%= product.id %>', document.getElementById('quantity-input').value)"
          class="btn btn-success btn-lg flex-grow-1"
          type="button"
          <%= (product.so_luong_ton_kho <= 0) ? 'disabled' : '' %>
        >
          <i class="fas fa-cart-plus me-2"></i>
          <%= (product.so_luong_ton_kho > 0) ? 'Thêm vào giỏ hàng' : 'Đã hết hàng' %>
        </button>

        <button
          class="btn btn-lg btn-outline-danger btn-favorite"
          data-id="<%= product.id %>"
          title="<%= isFav ? 'Bỏ thích' : 'Yêu thích' %>"
          type="button"
        >
          <i class="<%= isFav ? 'fas' : 'far' %> fa-heart"></i>
        </button>
      </div>
    </div>

    <!-- CỘT PHẢI: DỊCH VỤ & KHUYẾN MÃI -->
    <div class="col-lg-3">
      <div class="service-box">
        <h5 class="service-box-title">Dịch vụ của chúng tôi</h5>
        <ul class="list-unstyled">
          <li class="d-flex align-items-center mb-2">
            <i class="fas fa-truck text-primary fa-lg me-2"></i>
            <span>Giao tận nhà trong 3 - 7 ngày làm việc.</span>
          </li>
          <li class="d-flex align-items-center">
            <i class="fas fa-star text-warning fa-lg me-2"></i>
            <span>Miễn phí giao hàng toàn quốc cho đơn hàng trên 300k.</span>
          </li>
        </ul>
      </div>

      <div class="service-box mt-4">
        <h5 class="service-box-title">Dịch vụ & Khuyến mãi</h5>
        <ul class="list-unstyled">
          <li class="d-flex">
            <i class="fas fa-check-circle text-success me-2 mt-1"></i>
            <span>FREESHIP cho đơn hàng từ 300K trở lên.</span>
          </li>
        </ul>
      </div>
    </div>

  </div>

  <!-- MÔ TẢ SẢN PHẨM -->
  <div class="card my-5 shadow-sm border-0">
    <div class="card-body p-4">
      <h4 class="card-title fw-bold mb-4 border-bottom pb-2">Mô Tả Sản Phẩm</h4>
      <div class="product-description-content">
        <%- product.mo_ta_ngan || "Hiện chưa có mô tả chi tiết cho sản phẩm này." %>
      </div>
    </div>
  </div>

  <!-- ĐÁNH GIÁ SẢN PHẨM -->
  <div class="card my-5 shadow-sm border-0">
    <div class="card-body p-4">
      <h4 class="card-title fw-bold mb-4 border-bottom pb-2">Đánh Giá & Nhận Xét</h4>

      <!-- DASHBOARD ĐÁNH GIÁ -->
      <div class="row mb-5 border-bottom pb-4">
        <div class="col-md-4 text-center border-end">
          <h2 class="display-3 fw-bold text-warning"><%= avgRating %></h2>

          <div class="text-warning mb-2">
            <% const stars = Math.round(Number(avgRating)); %>
            <% for (let i = 0; i < stars; i++) { %>★<% } %>
            <% for (let i = 0; i < 5 - stars; i++) { %>☆<% } %>
          </div>

          <p class="text-muted"><%= reviews.length %> đánh giá</p>
        </div>

        <div class="col-md-8">
          <div class="d-flex flex-column justify-content-center h-100">
            <% 
              const starCounts = {1:0, 2:0, 3:0, 4:0, 5:0};
              reviews.forEach(r => { starCounts[r.rating]++; });
              const total = reviews.length || 1;
            %>

            <% for (let s = 5; s >= 1; s--) { %>
              <div class="d-flex align-items-center mb-1">
                <span class="me-2 text-nowrap"><%= s %> sao</span>

                <div class="progress flex-grow-1" style="height: 8px;">
                  <div
                    class="progress-bar bg-warning"
                    role="progressbar"
                    style="width: <%= (starCounts[s] / total) * 100 %>%;"
                    aria-valuenow="<%= starCounts[s] %>"
                    aria-valuemin="0"
                    aria-valuemax="<%= total %>"
                  ></div>
                </div>

                <span class="ms-2 text-muted small"><%= starCounts[s] %></span>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- DANH SÁCH ĐÁNH GIÁ -->
      <div id="review-list">
        <% if (reviews && reviews.length > 0) { %>
          <% reviews.forEach(review => { %>
            <div class="d-flex mb-4 border-bottom pb-3">
              <div class="flex-shrink-0">
                <img
                  class="rounded-circle shadow-sm"
                  src="https://ui-avatars.com/api/?name=<%= (review.user && review.user.ho_ten) ? review.user.ho_ten.split(' ').join('+') : 'A' %>&background=random&size=50"
                  alt="<%= (review.user && review.user.ho_ten) ? review.user.ho_ten : 'Ẩn danh' %>"
                  width="50"
                  height="50"
                >
              </div>

              <div class="ms-3 flex-grow-1">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="fw-bold mb-0">
                    <%= (review.user && review.user.ho_ten) ? review.user.ho_ten : 'Người dùng ẩn danh' %>
                  </h6>
                  <small class="text-muted">
                    <%= new Date(review.createdAt).toLocaleDateString('vi-VN') %>
                  </small>
                </div>

                <div class="text-warning my-1 small">
                  <% for (let i = 0; i < review.rating; i++) { %>★<% } %>
                  <% for (let i = 0; i < 5 - review.rating; i++) { %>☆<% } %>
                </div>

                <p class="mb-0 mt-2 text-dark"><%= review.comment %></p>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="text-center py-4 text-muted">
            <i class="far fa-comment-dots fa-3x mb-3"></i>
            <p>Chưa có đánh giá nào cho sản phẩm này. Hãy là người đầu tiên đánh giá!</p>
          </div>
        <% } %>
      </div>

      <!-- FORM ĐÁNH GIÁ -->
      <% if (user) { %>
        <% if (canReview) { %>
          <div class="bg-light p-4 rounded mt-4">
            <h5 class="mb-3">Viết đánh giá của bạn</h5>

            <form id="review-form">
              <div class="mb-3">
                <label class="form-label fw-bold">Đánh giá của bạn:</label>
                <div class="star-rating big-stars">
                  <input type="radio" id="5-stars" name="rating" value="5" />
                  <label for="5-stars" class="star">★</label>

                  <input type="radio" id="4-stars" name="rating" value="4" />
                  <label for="4-stars" class="star">★</label>

                  <input type="radio" id="3-stars" name="rating" value="3" />
                  <label for="3-stars" class="star">★</label>

                  <input type="radio" id="2-stars" name="rating" value="2" />
                  <label for="2-stars" class="star">★</label>

                  <input type="radio" id="1-star" name="rating" value="1" />
                  <label for="1-star" class="star">★</label>
                </div>
              </div>

              <div class="mb-3">
                <label for="review-comment" class="form-label fw-bold">Nhận xét chi tiết</label>
                <textarea
                  class="form-control"
                  id="review-comment"
                  rows="4"
                  placeholder="Chia sẻ cảm nhận của bạn về sản phẩm..."
                  required
                ></textarea>
              </div>

              <button type="submit" class="btn btn-primary px-4">Gửi Đánh Giá</button>
              <div id="review-alert" class="mt-3" style="display: none;"></div>
            </form>
          </div>
        <% } else { %>
          <div class="alert alert-info mt-4 d-flex align-items-center">
            <i class="fas fa-info-circle fa-2x me-3"></i>
            <div>
              <% if (deliveredOrderCount === 0) { %>
                <strong>Thông báo:</strong> Bạn chưa mua sản phẩm này nên chưa thể đánh giá.
              <% } else { %>
                <strong>Thông báo:</strong> Bạn đã đánh giá hết số lượt cho phép (1 lần/1 đơn hàng). Hãy mua thêm để tiếp tục đánh giá nhé!
              <% } %>
            </div>
          </div>
        <% } %>
      <% } else { %>
        <div class="alert alert-warning mt-4 text-center">
          Bạn cần <a href="/login" class="fw-bold alert-link">Đăng nhập</a> để viết đánh giá.
        </div>
      <% } %>

    </div>
  </div>

  <!-- SẢN PHẨM LIÊN QUAN -->
  <% if (relatedProducts && relatedProducts.length > 0) { %>
    <div class="mt-5">
      <h3 class="mb-4 pt-3 border-top">Sản Phẩm Liên Quan</h3>

      <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4 mb-5">
        <% relatedProducts.forEach(rProd => { %>
          <div class="col">
            <div class="card h-100 product-card position-relative border shadow-sm">
              <div class="position-relative">
                <a href="/products/<%= rProd.id %>">
                  <img
                    class="card-img-top w-100"
                    src="<%= (rProd.img && (rProd.img.startsWith('http') || rProd.img.startsWith('/'))) ? rProd.img : '/images/' + (rProd.img || 'placeholder.png') %>"
                    alt="<%= rProd.ten_sach %>"
                    style="height: 400px; object-fit: cover;"
                  >
                </a>
              </div>

              <div class="card-body d-flex flex-column p-3">
                <h6
                  class="card-title flex-grow-1"
                  style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; height: 3em; line-height: 1.5em;"
                >
                  <a
                    href="/products/<%= rProd.id %>"
                    class="text-decoration-none text-dark fw-bold"
                    title="<%= rProd.ten_sach %>"
                  >
                    <%= rProd.ten_sach %>
                  </a>
                </h6>

                <p class="card-text text-danger fw-bold fs-5 mb-3">
                  <%= parseFloat(rProd.gia_bia).toLocaleString('vi-VN') %> đ
                </p>

                <div class="mt-auto d-flex gap-2">
                  <button onclick="addToCart('<%= rProd.id %>')" class="btn btn-outline-primary flex-grow-1 btn-sm" type="button">
                    <i class="fas fa-cart-plus me-1"></i> Thêm vào giỏ hàng
                  </button>

                  <%
                    const isFavRelated =
                      (typeof favoriteProductIds !== 'undefined') &&
                      favoriteProductIds.some(fid => String(fid) === String(rProd.id));
                  %>

                  <button
                    class="btn btn-outline-danger btn-sm btn-favorite-card btn-favorite"
                    data-id="<%= rProd.id %>"
                    title="<%= isFavRelated ? 'Bỏ thích' : 'Yêu thích' %>"
                    type="button"
                  >
                    <i class="<%= isFavRelated ? 'fas' : 'far' %> fa-heart"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>
</div>

<!-- JS -->
<script src="https://kit.fontawesome.com/9b1e6729d6.js" crossorigin="anonymous"></script>
<script src="/js/cart.js"></script>
<script src="/js/favorite.js"></script>
<script src="/js/product-detail.js"></script>

<%- include('../partials/footer') %>
