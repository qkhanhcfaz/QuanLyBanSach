<%- include('../partials/header') %>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Quản lý Liên hệ</h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách Tin nhắn Liên hệ</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="contactsTable" width="100%" cellspacing="0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Họ tên</th>
                            <th>Email</th>
                            <th>Chủ đề</th>
                            <th>Nội dung</th>
                            <th>Ngày gửi</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                        <!-- JS renders here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const tableBody = document.getElementById('contactsTableBody');
    const token = localStorage.getItem('token');

    async function loadContacts() {
        try {
            const res = await fetch('/api/contacts', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const contacts = await res.json();
            
            tableBody.innerHTML = '';
            if (contacts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có tin nhắn nào.</td></tr>';
                return;
            }

            contacts.forEach(contact => {
                const date = new Date(contact.createdAt).toLocaleString('vi-VN');
                const row = `
                    <tr>
                        <td>${contact.id}</td>
                        <td>${contact.ho_ten}</td>
                        <td>${contact.email}</td>
                        <td>${contact.chu_de || '(Không tiêu đề)'}</td>
                        <td>${contact.noi_dung}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-danger btn-sm btn-delete" data-id="${contact.id}">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add delete event listeners
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', handleDelete);
            });

        } catch (error) {
            console.error(error);
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
        }
    }

    async function handleDelete(e) {
        const id = e.target.closest('.btn-delete').dataset.id;
        
        const result = await Swal.fire({
            title: 'Chắc chắn xóa?',
            text: "Bạn không thể hoàn tác hành động này!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        });

        if (result.isConfirmed) {
            try {
                const res = await fetch(`/api/contacts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    Swal.fire('Đã xóa!', 'Tin nhắn đã được xóa.', 'success');
                    loadContacts();
                } else {
                    Swal.fire('Lỗi!', 'Không thể xóa tin nhắn.', 'error');
                }
            } catch (error) {
                Swal.fire('Lỗi network!', error.message, 'error');
            }
        }
    }

    loadContacts();
});
</script>
