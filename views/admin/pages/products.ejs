<%- include('../partials/header') %>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Quản lý Sản phẩm</h1>
        <a href="/admin/products/add" class="btn btn-success">
            <i class="fas fa-plus me-1"></i> Thêm sản phẩm mới
        </a>
    </div>

    <div class="card">
        <!-- ========================================================== -->
        <!-- ================ KHUNG TÌM KIẾM & SẮP XẾP ================ -->
        <!-- ========================================================== -->
        <div class="card-header">
            <form id="filter-form" action="/admin/products" method="GET">
                <div class="row g-3">
                    <!-- Ô TÌM KIẾM -->
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Tìm kiếm</label>
                        <input type="search" name="keyword" class="form-control form-control-sm"
                            placeholder="Tên sản phẩm..." value="<%= typeof keyword !== 'undefined' ? keyword : '' %>">
                    </div>

                    <!-- LỌC THEO GIÁ -->
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Giá (từ - đến)</label>
                        <div class="input-group input-group-sm">
                            <input type="number" name="minPrice" class="form-control" placeholder="Từ"
                                value="<%= typeof minPrice !== 'undefined' ? minPrice : '' %>">
                            <input type="number" name="maxPrice" class="form-control" placeholder="Đến"
                                value="<%= typeof maxPrice !== 'undefined' ? maxPrice : '' %>">
                        </div>
                    </div>

                    <!-- LỌC THEO TỒN KHO -->
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Tồn kho</label>
                        <div class="input-group input-group-sm">
                            <input type="number" name="minStock" class="form-control" placeholder="Từ"
                                value="<%= typeof minStock !== 'undefined' ? minStock : '' %>">
                            <input type="number" name="maxStock" class="form-control" placeholder="Đến"
                                value="<%= typeof maxStock !== 'undefined' ? maxStock : '' %>">
                        </div>
                    </div>

                    <!-- TRẠNG THÁI -->
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Trạng thái</label>
                        <select name="status" class="form-select form-select-sm">
                            <option value="">Tất cả</option>
                            <option value="1" <%=typeof status !=='undefined' && status=='1' ? 'selected' : '' %>>Hiển
                                thị</option>
                            <option value="0" <%=typeof status !=='undefined' && status=='0' ? 'selected' : '' %>>Ẩn
                            </option>
                        </select>
                    </div>

                    <!-- SẮP XẾP -->
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Sắp xếp</label>
                        <select name="sort" id="sort-select" class="form-select form-select-sm">
                            <option value="createdAt_DESC" <%=(sortBy==='createdAt' && order==='DESC' ) ? 'selected'
                                : '' %>>Mới nhất</option>
                            <option value="createdAt_ASC" <%=(sortBy==='createdAt' && order==='ASC' ) ? 'selected' : ''
                                %>>Cũ nhất</option>
                            <option value="gia_bia_DESC" <%=(sortBy==='gia_bia' && order==='DESC' ) ? 'selected' : '' %>
                                >Giá Giảm</option>
                            <option value="gia_bia_ASC" <%=(sortBy==='gia_bia' && order==='ASC' ) ? 'selected' : '' %>
                                >Giá Tăng</option>
                            <option value="so_luong_ton_kho_DESC" <%=(sortBy==='so_luong_ton_kho' && order==='DESC' )
                                ? 'selected' : '' %>>Tồn kho ↓</option>
                            <option value="so_luong_ton_kho_ASC" <%=(sortBy==='so_luong_ton_kho' && order==='ASC' )
                                ? 'selected' : '' %>>Tồn kho ↑</option>
                        </select>
                    </div>

                    <div class="col-12 d-flex justify-content-end gap-2">
                        <a href="/admin/products" class="btn btn-sm btn-secondary">Đặt lại</a>
                        <button type="submit" class="btn btn-sm btn-primary px-4 text-white">Lọc dữ liệu</button>
                    </div>
                </div>

                <!-- Các input ẩn để giữ lại sortBy/order thuần nếu cần (cho logic JS cũ) -->
                <input type="hidden" name="sortBy" value="<%= typeof sortBy !== 'undefined' ? sortBy : 'createdAt' %>">
                <input type="hidden" name="order" value="<%= typeof order !== 'undefined' ? order : 'DESC' %>">
            </form>
        </div>

        <!-- ========================================================== -->
        <!-- ====================== BẢNG DỮ LIỆU ======================= -->
        <!-- ========================================================== -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá</th>
                            <th>Tồn kho</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                        <% if (products && products.length> 0) { %>
                            <% products.forEach(product=> { %>
                                <tr id="product-row-<%= product.id %>">
                                    <td>
                                        <%= product.id %>
                                    </td>
                                    <td>
                                        <img src="<%= product.img %>" alt="<%= product.ten_sach %>" width="50"
                                            class="img-fluid rounded">
                                    </td>
                                    <td>
                                        <%= product.ten_sach %>
                                    </td>
                                    <td>
                                        <%= parseFloat(product.gia_bia).toLocaleString('vi-VN', { style: 'currency' ,
                                            currency: 'VND' }) %>
                                    </td>
                                    <td class="text-center">
                                        <%= product.so_luong_ton_kho %>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm status-select"
                                            data-id="<%= product.id %>" style="width: auto;">
                                            <option value="1" <%=product.trang_thai===1 ? 'selected' : '' %>>Hiển thị
                                            </option>
                                            <option value="0" <%=product.trang_thai===0 ? 'selected' : '' %>>Ẩn</option>
                                        </select>
                                    </td>
                                    <td>
                                        <a href="/admin/products/edit/<%= product.id %>" class="btn btn-sm btn-warning"
                                            title="Sửa"><i class="fas fa-edit"></i></a>
                                        <button class="btn btn-sm btn-danger delete-product-btn"
                                            data-id="<%= product.id %>" title="Xóa">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-4">Không có sản phẩm nào phù hợp.</td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========================================================== -->
        <!-- ======================= PHÂN TRANG ======================= -->
        <!-- ========================================================== -->
        <% if (totalPages> 1) { %>
            <div class="card-footer">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-end mb-0">
                        <!-- Nút Previous -->
                        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                            <a class="page-link"
                                href="?page=<%= currentPage - 1 %>&keyword=<%= keyword %>&sortBy=<%= sortBy %>&order=<%= order %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>&minStock=<%= minStock %>&maxStock=<%= maxStock %>&status=<%= status %>">Trước</a>
                        </li>

                        <!-- Các nút số trang -->
                        <% for(let i=1; i <=totalPages; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link"
                                    href="?page=<%= i %>&keyword=<%= keyword %>&sortBy=<%= sortBy %>&order=<%= order %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>&minStock=<%= minStock %>&maxStock=<%= maxStock %>&status=<%= status %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>

                                <!-- Nút Next -->
                                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= currentPage + 1 %>&keyword=<%= keyword %>&sortBy=<%= sortBy %>&order=<%= order %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>&minStock=<%= minStock %>&maxStock=<%= maxStock %>&status=<%= status %>">Sau</a>
                                </li>
                    </ul>
                </nav>
            </div>
            <% } %>
    </div>

    <%- include('../partials/footer') %>

        <!-- Import file JS xử lý nút xóa -->
        <script src="/js/admin-product.js"></script>